name: Build and Deploy Spring Boot App to EC2 via Docker


on:

  push:

    branches:

      - main


jobs:

  build-and-deploy:

    runs-on: ubuntu-latest


    steps:

    - name: Checkout code

      uses: actions/checkout@v3


    - name: Set up JDK 17

      uses: actions/setup-java@v3

      with:

        java-version: '17'


    - name: Build JAR

      run: mvn clean package -DskipTests


    - name: Build Docker image

      run: docker build -t myapp:latest .


    - name: Log in to DockerHub

      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin


    - name: Push image to DockerHub

      run: |

        docker tag myapp:latest ${{ secrets.DOCKER_USERNAME }}/myapp:latest

        docker push ${{ secrets.DOCKER_USERNAME }}/myapp:latest


    - name: SSH and deploy on EC2

      uses: appleboy/ssh-action@master

      with:

        host: ${{ secrets.EC2_HOST }}

        username: ${{ secrets.EC2_USER }}

        key: ${{ secrets.EC2_SSH_KEY }}

        script: |

          docker pull ${{ secrets.DOCKER_USERNAME }}/myapp:latest

          docker stop myapp || true

          docker rm myapp || true

          docker run -d -p 8080:8080 --name myapp ${{ secrets.DOCKER_USERNAME }}/myapp:latest

